<!DOCTYPE html>
<html>
<head>
    <title>Jogo Multiplayer</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f1f1f1;
        }

        /* Estilos para o canvas */
        #gameCanvas {
            border: 2px solid black;
            background-color: white;
            display: none; /* Esconder o canvas até o início do jogo */
        }

        #avatarSelection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        #avatarSelection img {
            width: 120px;
            height: 120px;
            margin: 10px;
            cursor: pointer;
            border: 4px solid transparent;
            border-radius: 50%;
            transition: border-color 0.3s;
        }

        #avatarSelection img.selected {
            border-color: #00f1ff;
        }
    </style>
</head>
<body>
    <div id="nicknameDialog">
        <label for="nickname">Nickname:</label>
        <input type="text" id="nickname" maxlength="20">
        <button onclick="setNickname()">Confirmar</button>
    </div>
    <div id="avatarSelection">
        <p>Escolha seu avatar:</p>
        <img src="https://moratoproject.000webhostapp.com/Avatares/Picsart_23-07-20_00-19-21-262.png" onclick="selectAvatar(1)">
        <img src="https://moratoproject.000webhostapp.com/Avatares/Picsart_23-07-20_00-18-14-296.png" onclick="selectAvatar(2)">
    </div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <script>
        const socket = io('http://localhost:5000'); // Conexão com o servidor

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const moveSpeed = 5;

        let playerX = canvas.width / 2;
        let playerY = canvas.height / 2;
        let moveX = 0;
        let moveY = 0;
        let nickname = '';
        let playerId = null;
        let gameStarted = false;
        let selectedAvatar = 1; // Avatar padrão selecionado
        const players = {}; // Armazenar informações dos jogadores conectados

        function setNickname() {
            const inputNickname = document.getElementById('nickname').value;
            if (inputNickname.trim() !== '') {
                nickname = inputNickname;
                document.getElementById('nicknameDialog').style.display = 'none'; // Esconder o diálogo de entrada do nickname
                document.getElementById('avatarSelection').style.display = 'none'; // Esconder a seleção de avatar
                document.getElementById('gameCanvas').style.display = 'block'; // Mostrar o canvas
                gameStarted = true; // Permitir o início do jogo
                socket.emit('setNickname', { nickname, avatar: selectedAvatar }); // Enviar o nickname e o avatar selecionado para o servidor
                startGame();
            }
        }

        function selectAvatar(avatarNumber) {
            selectedAvatar = avatarNumber;
            const avatarImages = document.querySelectorAll('#avatarSelection img');
            avatarImages.forEach((img, index) => {
                if (avatarNumber === index + 1) {
                    img.classList.add('selected'); // Adicionar a classe 'selected' ao avatar selecionado
                } else {
                    img.classList.remove('selected'); // Remover a classe 'selected' dos outros avatares
                }
            });
        }

        function startGame() {
            playerId = socket.id; // Armazenar o ID do jogador local
            setupEventListeners(); // Configurar os eventos de movimentação do jogador
            updatePosition();
        }

        socket.on('connect', () => {
            console.log(`Conectado com o ID: ${socket.id}`);
        });

        socket.on('disconnect', () => {
            console.log(`Desconectado do servidor`);
            // Limpeza do jogo, caso necessário
        });

        socket.on('playerLeft', (data) => {
            if (gameStarted) {
                const leftPlayerNickname = data.nickname;
                delete players[leftPlayerNickname]; // Remove o jogador desconectado da lista de jogadores
            }
        });

        socket.on('update', (serverPlayers) => {
            if (gameStarted) {
                // Atualizar as informações dos jogadores conectados
                for (const [socketId, playerData] of Object.entries(serverPlayers)) {
                    if (socketId === playerId) {
                        // Se o jogador local, atualize a posição
                        playerX = playerData.x;
                        playerY = playerData.y;
                        nickname = playerData.nickname;
                        selectedAvatar = playerData.avatar;
                    } else {
                        // Se jogador remoto, atualize a lista de jogadores
                        players[socketId] = {
                            x: playerData.x,
                            y: playerData.y,
                            nickname: playerData.nickname,
                            avatar: playerData.avatar,
                        };
                    }
                }

                // Limpar o canvas antes de desenhar os jogadores atualizados
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Desenhar todos os jogadores
                for (const playerData of Object.values(players)) {
                    const x = playerData.x;
                    const y = playerData.y;
                    const remoteNickname = playerData.nickname;
                    const remoteAvatar = new Image();
                    remoteAvatar.src = getAvatarURL(playerData.avatar);

                    // Certifique-se de carregar a imagem do avatar antes de desenhá-la no canvas
                    remoteAvatar.onload = () => {
                        ctx.drawImage(remoteAvatar, x - 30, y - 30, 60, 60);
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(remoteNickname, x, y - 40);
                    };
                }

                // Desenhar o jogador local (avatar selecionado) na posição x, y
                const localAvatar = new Image();
                localAvatar.src = getAvatarURL(selectedAvatar);

                // Certifique-se de carregar a imagem do avatar antes de desenhá-la no canvas
                localAvatar.onload = () => {
                    ctx.drawImage(localAvatar, playerX - 30, playerY - 30, 60, 60);
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(nickname, playerX, playerY - 40);
                };
            }
        });

        function sendMove(x, y) {
            socket.emit('move', { x, y });
        }

        // Capturar eventos de teclas para movimentar o jogador local
        function setupEventListeners() {
            document.addEventListener('keydown', (event) => {
                switch (event.keyCode) {
                    case 37: // Esquerda
                        moveX = -moveSpeed;
                        break;
                    case 38: // Cima
                        moveY = -moveSpeed;
                        break;
                    case 39: // Direita
                        moveX = moveSpeed;
                        break;
                    case 40: // Baixo
                        moveY = moveSpeed;
                        break;
                }
            });

            document.addEventListener('keyup', () => {
                moveX = 0;
                moveY = 0;
            });
        }

        function updatePosition() {
            if (gameStarted) {
                requestAnimationFrame(updatePosition);

                // Atualizar a posição do jogador local com base nas teclas pressionadas
                playerX += moveX;
                playerY += moveY;

                // Restringir a posição do avatar aos limites da tela
                playerX = Math.max(30, Math.min(canvas.width - 30, playerX));
                playerY = Math.max(30, Math.min(canvas.height - 30, playerY));

                // Enviar a posição atualizada para o servidor
                sendMove(playerX, playerY);
            }
        }
        function getAvatarURL(avatarNumber) {
    switch (avatarNumber) {
        case 1:
            return 'https://moratoproject.000webhostapp.com/Avatares/Picsart_23-07-20_00-19-21-262.png';
        case 2:
            return 'https://moratoproject.000webhostapp.com/Avatares/Picsart_23-07-20_00-18-14-296.png';
        default:
            return 'https://moratoproject.000webhostapp.com/Avatares/Picsart_23-07-20_00-19-21-262.png';
    }
}


      
        // Iniciar o jogo após o carregamento da página
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('nicknameDialog').style.display = 'block'; // Mostrar o diálogo de entrada do nickname
        });

        updatePosition();
    </script>
</body>
</html>
